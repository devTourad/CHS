<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Fiche pondérée – Modèle officiel CH Sélibaby (v2)</title>
<style>
  :root{
    --bg:#f7f9fc;
    --card:#ffffff;
    --ink:#111827;
    --muted:#6b7280;
    --accent:#0ea5e9;
    --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans"; background:var(--bg); color:var(--ink)}
  .container{max-width:1100px; margin:0 auto; padding:16px}
  .paper{background:#fff; border:1px solid var(--border); border-radius:12px; padding:18px; margin:16px auto}
  .hdr{display:grid; grid-template-columns:140px 1fr 140px; align-items:center; gap:10px; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:14px}
  .logo{width:120px; height:120px; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; overflow:hidden; border-radius:8px; background:#fafafa}
  .logo img{max-width:100%; max-height:100%; object-fit:contain}
  .titles{ text-align:center }
  .titles h1{ font-size:1.15rem; margin:0 0 4px 0 }
  .sub{font-size:.95rem; color:#374151}
  .sub .rtl{direction:rtl}
  .meta{display:flex; flex-wrap:wrap; gap:10px; margin-top:6px; justify-content:center; font-weight:600}
  .pill{border:1px solid var(--border); border-radius:999px; padding:4px 10px; background:#f8fafc}
  .controls{display:flex; flex-wrap:wrap; gap:10px; margin:10px 0}
  button,input[type="file"]{font-weight:600; border:1px solid var(--border); border-radius:10px; padding:8px 12px; background:#fff; cursor:pointer}
  .grid{display:grid; grid-template-columns:1fr; gap:12px}
  .section{border:1px solid var(--border); border-radius:10px; padding:12px}
  .section h3{margin:0 0 6px 0; font-size:1rem}
  label{display:block; margin:.35rem 0 .25rem 0; font-weight:600}
  select, input[type="number"], input[type="text"]{width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#fff}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .score{display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border:1px dashed var(--accent); border-radius:10px; background:#f0f9ff; font-weight:700}
  .status{padding:6px 10px; border-radius:999px; border:1px solid #ddd}
  .ok{background:#ecfdf5} .warn{background:#fff7ed} .bad{background:#fef2f2}
  .footer{margin-top:10px; color:var(--muted); font-size:.9rem}
  .rtl{direction:rtl; text-align:right}
  @media(min-width:920px){ .grid{grid-template-columns:2fr 1fr} }
  @media print{
   
  }
</style>
</head>
<body>
  {% include 'navbar.html' %}
  <div class="container">
    <form method="post">
      {% csrf_token %}


    <div class="paper">
      <div class="hdr">
        <div class="logo" id="logoBox"></div>
        <div class="titles">
          <h1>Fiche pondérée – Enquête sociale • <span class="rtl">استمارة التنقيط للتحقيق الاجتماعي</span></h1>
          <div class="sub">Centre Hospitalier de Sélibaby • <span class="rtl">المستشفى الجهوي بسيليبابي</span></div>
          <div class="meta">
            <div class="pill">Numéro de dossier : <span id="numDossier">{{ preview_num }}</span></div>
            <div class="pill">Date : <span id="dateJour">{{ today_date }}</span></div>
          </div>
        </div>
        <div class="logo" id="logoBox2"><span style="font-size:.85rem;color:#6b7280">Logo (option)</span></div>
      </div>

      <div class="grid">
        <div class="section">
          <h3>Informations personnelles • <span class="rtl">المعلومات الشخصية</span></h3>
          <label>Nom et prénom • <span class="rtl">الاسم الكامل</span></label>
          {{ form.nom }}
          <label>Quartier • <span class="rtl">الحي</span></label>
          {{ form.quartier }}
          <label>Wilaya • <span class="rtl">الولاية</span></label>
          {{ form.wilaya }}
          <label>Moughataa • <span class="rtl">المقاطعة</span></label>
          {{ form.moughataa }}
          <label>NNI • <span class="rtl">الرقم الوطني</span></label>
          {{ form.nni }}
          <label>Âge • <span class="rtl">العمر</span></label>
          {{ form.age }}
          <label>Sexe • <span class="rtl">الجنس</span></label>
          {{ form.sexe }}
          <label>Situation matrimoniale • <span class="rtl">الحالة الزوجية</span></label>
          {{ form.situation_matrimoniale }}
        </div>
        <div class="section">
          <h3>1) Conditions sociales et familiales • <span class="rtl">الظروف الاجتماعية والأسرية</span></h3>
          <label>Statut dans le ménage</label>
          {{ form.role }}
          <label>Situation de cohabitation</label>
          {{ form.situation_de_vie }}
          <label>Téléphone portable</label>
          {{ form.tel }}
          <div class="row">
            <div style="flex:1">
              <label>Nb. d’enfants 0–5 ans</label>{{ form.enf05 }}<div class="footer">1 pt / enfant</div>
            </div>
            <div style="flex:1">
              <label>Nb. d’enfants orphelins</label>{{ form.Orphelins_dans_le_ménage }}<div class="footer">2 pts / enfant</div>
            </div>
            <div style="flex:1">
              <label>Autres personnes à charge</label>{{ form.personne_a_charge }}<div class="footer">1 pt / personne</div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>2) Habitat • <span class="rtl">السكن</span></h3>
          <label>2.1 Type</label>
          {{ form.hab_type }}
          <label>2.2 Nombre de pièces</label>
          {{ form.pieces }}
          <label>2.3 Statut de propriété</label>
          {{ form.propriete }}
          <label>2.4 Éclairage</label>
          {{ form.eclairage }}
          <label>2.5 Approvisionnement en eau</label>
          {{ form.eau }}
          <label>2.6 Latrines</label>
          {{ form.latrine }}
        </div>

        <div class="section">
          <h3>3) Revenu • <span class="rtl">الدخل</span></h3>
          <label>Situation</label>
          {{ form.emploi }}
            <label>Nature de l’emploi</label>
            {{ form.nature_emploi }}
            <label>Montant mensuel</label>
            {{ form.revenu_mensuel }}
            <label>Revenu mensuelle (UM)</label>
            {{ form.revenu_mensuelle }}
          
          <div id="bloc_sans_emploi">
            <label>Motif</label>
            {{ form.raison_chomage }}
          </div>
          <label>Principal soutien de la famille</label>
          {{ form.soutien }}
        </div>

        <div class="section">
          <h3>4) Avoirs fonciers à intérêt • <span class="rtl">الأملاك العقارية ذات العائد</span></h3>
          <label for="foncier">Type</label>
          {{ form.foncier }}
        </div>

        <div class="section">
          <h3>5) Avoirs pastoraux • <span class="rtl">الأملاك الحيوانية</span></h3>
          <div class="row">
            <div style="flex:1">
              <label>Chameaux</label>{{ form.camelins }}<div class="footer">0: 5 pts • 1–4: 2 pts • 5+: 0</div>
            </div>
            <div style="flex:1">
              <label>Bovins</label>{{ form.bovins }}<div class="footer">0: 6 • 1–3: 3 • 4–5: 2 • 6+: 0</div>
            </div>
            <div style="flex:1">
              <label>Ovins/Caprins</label>{{ form.ovins }}<div class="footer">0–2: 10 • 3–5: 6 • 6–10: 2 • 11+: 0</div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>6) Santé • <span class="rtl">الصحة</span></h3>
          <div class="row">
            <div style="flex:1">
              <label>Malades de longue durée</label>{{ form.malades }}<div class="footer">2 pts / personne</div>
            </div>
            <div style="flex:1">
              <label>Personnes handicapées</label>{{ form.handicapes }}<div class="footer">2 pts / personne</div>
            </div>
            <div style="flex:1">
              <label>Polyhandicapés</label>{{ form.poly }}<div class="footer">4 pts / personne</div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>Score & décision • <span class="rtl">النتيجة والقرار</span></h3>
          <div class="score">
            <div>Total • <strong id="score">0</strong></div>
            <div id="decision" class="status ok">Non indigent • غير فقير</div>
          </div>
          <div class="footer">Seuil d’indigence : &gt; 90 points.</div>
          <div class="footer">N° dossier et date apparaissent aussi sur l’impression/PDF.</div>
        </div>
      </div>

      <div class="footer">Version officielle – CHS/IS (v2)</div>
      <div class="row mb-4">
    <div class="col-12 d-flex justify-content-end gap-2">

      <button class="btn btn-primary btn-lg" type="submit">Enregistrer</button>
      <button class="btn btn-secondary btn-lg" onclick="window.print()">Imprimer</button>
      <button class="btn btn-dark btn-lg" >Annuler</button>
    </div>
    </div>
    </div>
    
    </form>
  
  </div>

<script>
function calculateScore() {
    let s = 0;

    const role = document.getElementById('id_role').value;
    const sexe = document.getElementById('id_sexe').value;
    if (role === 'chef_menage') {
        s += sexe === 'homme' ? 6 : 8;
    } else if (role === 'membre') {
        s += 3;
    }

    const situation_de_vie = document.getElementById('id_situation_de_vie').value;
    if (situation_de_vie === 'famille_parente') {
        s += 5;
    } else if (situation_de_vie === 'famille_non_parente') {
        s += 8;
    } else if (situation_de_vie === 'seul_errant') {
        s += 10;
    }

    const tel = document.getElementById('id_tel').value;
    s += tel === 'oui' ? 1 : 5;

    const enf05 = parseInt(document.getElementById('id_enf05').value) || 0;
    s += enf05 * 1;

    const orphelins = parseInt(document.getElementById('id_Orphelins_dans_le_ménage').value) || 0;
    s += orphelins * 2;

    const personne_a_charge = parseInt(document.getElementById('id_personne_a_charge').value) || 0;
    s += personne_a_charge * 1;

    const hab_type = document.getElementById('id_hab_type').value;
    if (hab_type === 'tente') {
        s += 8;
    } else if (['hangar', 'baraque'].includes(hab_type)) {
        s += 6;
    } else if (hab_type === 'banco') {
        s += 5;
    } else if (hab_type === 'zinc') {
        s += 3;
    } else if (hab_type === 'beton') {
        s += 2;
    }

    const pieces = document.getElementById('id_pieces').value;
    if (pieces === '1_2') {
        s += 4;
    } else if (pieces === '3_4') {
        s += 1;
    }

    const propriete = document.getElementById('id_propriete').value;
    if (propriete === 'prete') {
        s += 4;
    } else if (propriete === 'location') {
        s += 2;
    } else if (propriete === 'proprietaire') {
        s += 1;
    }

    const eclairage = document.getElementById('id_eclairage').value;
    if (eclairage === 'bougie') {
        s += 4;
    } else if (eclairage === 'electricite') {
        s += 1;
    }

    const eau = document.getElementById('id_eau').value;
    if (eau === 'adduction') {
        s += 0;
    } else if (eau === 'reserve') {
        s += 2;
    } else if (eau === 'charrette') {
        s += 4;
    } else if (eau === 'puits') {
        s += 6;
    }

    const latrine = document.getElementById('id_latrine').value;
    s += latrine === 'oui' ? 2 : 6;

    const emploi = document.getElementById('id_emploi').value;
    if (emploi === 'emploi') {
        const nature_emploi = document.getElementById('id_nature_emploi').value;
        if (nature_emploi === 'fixe') {
            s += 0;
        } else if (nature_emploi === 'temporaire') {
            s += 4;
        } else if (nature_emploi === 'saisonnier') {
            s += 6;
        }
        const revenu_mensuel = document.getElementById('id_revenu_mensuel').value;
        if (revenu_mensuel === 'moins_25000') {
            s += 6;
        } else if (revenu_mensuel === '25k_30k') {
            s += 3;
        }
    } else {
        const raison_chomage = document.getElementById('id_raison_chomage').value;
        if (raison_chomage === 'incapacite') {
            s += 10;
        } else if (raison_chomage === 'chomage') {
            s += 6;
        }
    }

    const soutien = document.getElementById('id_soutien').value;
    if (soutien === 'proche') {
        s += 6;
    } else if (soutien === 'autres') {
        s += 10;
    }

    const foncier = document.getElementById('id_foncier').value;
    if (foncier === 'commercial') {
        s += 0;
    } else if (foncier === 'agricole') {
        s += 2;
    } else if (foncier === 'habitation') {
        s += 4;
    } else if (foncier === 'neant') {
        s += 8;
    }

    const camelins = parseInt(document.getElementById('id_camelins').value) || 0;
    if (camelins === 0) {
        s += 5;
    } else if (camelins >= 1 && camelins <= 4) {
        s += 2;
    } // 5+ : 0

    const bovins = parseInt(document.getElementById('id_bovins').value) || 0;
    if (bovins === 0) {
        s += 6;
    } else if (bovins >= 1 && bovins <= 3) {
        s += 3;
    } else if (bovins >= 4 && bovins <= 5) {
        s += 2;
    } // 6+ : 0

    const ovins = parseInt(document.getElementById('id_ovins').value) || 0;
    if (ovins >= 0 && ovins <= 2) {
        s += 10;
    } else if (ovins >= 3 && ovins <= 5) {
        s += 6;
    } else if (ovins >= 6 && ovins <= 10) {
        s += 2;
    } // 11+ : 0

    const malades = parseInt(document.getElementById('id_malades').value) || 0;
    s += malades * 2;

    const handicapes = parseInt(document.getElementById('id_handicapes').value) || 0;
    s += handicapes * 2;

    const poly = parseInt(document.getElementById('id_poly').value) || 0;
    s += poly * 4;

    // Update display
    document.getElementById('score').textContent = s;
    const decisionEl = document.getElementById('decision');
    if (s > 90) {
        decisionEl.textContent = 'Indigent • فقير مستحق';
        decisionEl.className = 'status bad';
    } else {
        decisionEl.textContent = 'Non indigent • غير فقير';
        decisionEl.className = 'status ok';
    }
}

// Add event listeners to all inputs
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.addEventListener('input', calculateScore);
        input.addEventListener('change', calculateScore);
    });
    // Initial calculation
    calculateScore();
});
</script>

</body>
</html>
